<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ race_name }} - Resultados del Análisis</title>
    <!-- Incluye Tailwind CSS para estilos de utilidad -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Estilos personalizados que Tailwind no maneja o para overrides específicos */
      body {
        font-family: 'Inter', sans-serif;
      }
      .pace-input, .rest-input {
          width: 60px;
      }
      th, td {
          word-wrap: break-word;
      }
    </style>
</head>
<body class="font-sans bg-gray-100 text-gray-800 p-4 sm:p-8">
    
    <h1 class="text-3xl sm:text-4xl font-extrabold text-center mb-6 text-gray-900">{{ race_name }} - Resultados del Análisis</h1>
    
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg mb-8">
        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-700">Gráfico de Altimetría</h2>
        <img src="{{ altimetry_plot_url }}" alt="Gráfico de altimetría" class="w-full h-auto rounded-lg shadow-md mb-4 border border-gray-200">
    </div>

    <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg mb-8">
        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-700">Plano 2D del Circuito</h2>
        <img src="{{ map_plot_url }}" alt="Plano 2D" class="w-full h-auto rounded-lg shadow-md mb-4 border border-gray-200">
    </div>

    <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg mb-8">
        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-700">Mapa Interactivo (OpenStreetMap)</h2>
        <iframe src="{{ url_for('static', filename='plots/osm_map.html') }}" width="100%" height="500" class="border-none rounded-lg shadow-md"></iframe>
    </div>

    <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg mb-8">
        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-700">Análisis de Sub-segmentos</h2>
        <form action="/" method="post" id="mainForm">
            
            <h3 class="text-lg font-semibold mt-6 mb-2 text-gray-700">Planificar Paradas/Descansos</h3>
            <p class="text-sm text-gray-600 mb-4">Indica la distancia y el tiempo en minutos para cada parada planificada. Haz clic en "Agregar Parada" para añadir más.</p>
            <table id="restStopsTable" class="w-full table-fixed border-collapse mb-4 bg-white rounded-lg shadow-inner overflow-hidden">
                <thead class="bg-gray-200 sticky top-0 z-10">
                    <tr>
                        <th class="p-2 border border-gray-300 text-center">Parada #</th>
                        <th class="p-2 border border-gray-300 text-center">Distancia (km)</th>
                        <th class="p-2 border border-gray-300 text-center">Tiempo (min)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="p-2 border border-gray-300 text-center">1</td>
                        <td class="p-2 border border-gray-300 text-center"><input type="text" class="rest-input w-full p-1 border border-gray-300 rounded-md text-center" name="rest_stop_km_0" placeholder="Ej: 5.5"></td>
                        <td class="p-2 border border-gray-300 text-center"><input type="text" class="rest-input w-full p-1 border border-gray-300 rounded-md text-center" name="rest_stop_min_0" placeholder="Ej: 10"></td>
                    </tr>
                </tbody>
            </table>
            <div class="flex justify-center mb-8">
                <button type="button" onclick="addRestStop()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-full shadow-md hover:bg-blue-700 transition-colors">Agregar Parada</button>
            </div>
    
            <table class="w-full table-fixed border-collapse mb-8 bg-white rounded-lg shadow-md overflow-hidden">
                <thead class="bg-gray-200 sticky top-0 z-10">
                    <tr>
                        <th class="p-2 border border-gray-300 text-center">Distancia<br>origen<br>(km)</th>
                        <th class="p-2 border border-gray-300 text-center">Altitud<br>Ganada<br>(m)</th>
                        <th class="p-2 border border-gray-300 text-center">Altitud<br>Perdida<br>(m)</th>
                        <th class="p-2 border border-gray-300 text-center">Pendiente<br>Promedio (%)</th>
                        <th class="p-2 border border-gray-300 text-center">Pendiente<br>Máxima (°)</th>
                        <th class="p-2 border border-gray-300 text-center">Ritmo<br>(mm:ss)</th>
                        <th class="p-2 border border-gray-300 text-center">Altitud<br>Ganada<br>Acumulada<br>(m)</th>
                        <th class="p-2 border border-gray-300 text-center">Altitud<br>Perdida<br>Acumulada<br>(m)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for segment in segment_data %}
                    <tr>
                        <td class="p-2 border border-gray-300 text-center">{{ "%.2f"|format(segment.dist_origen_km) }}</td>
                        <td class="p-2 border border-gray-300 text-center">{{ "%.2f"|format(segment.altitud_ganada) }}</td>
                        <td class="p-2 border border-gray-300 text-center">{{ "%.2f"|format(segment.altitud_perdida) }}</td>
                        <td class="p-2 border border-gray-300 text-center">{{ "%.2f"|format(segment.pendiente_promedio_pct) }}</td>
                        <td class="p-2 border border-gray-300 text-center">{{ "%.2f"|format(segment.pendiente_max_angulo) }}</td>
                        <td class="p-2 border border-gray-300 text-center">
                            <input type="text" class="pace-input w-full p-1 border border-gray-300 rounded-md text-center" name="pace_{{ loop.index0 }}" placeholder="mm:ss">
                            <input type="hidden" name="dist_{{ loop.index0 }}" value="{{ segment.dist_origen_km }}">
                        </td>
                        <td class="p-2 border border-gray-300 text-center">{{ "%.2f"|format(segment.altitud_ganada_acumulada) }}</td>
                        <td class="p-2 border border-gray-300 text-center">{{ "%.2f"|format(segment.altitud_perdida_acumulada) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <input type="hidden" name="race_name" value="{{ race_name }}">
            <input type="hidden" name="pa_locations" value='{{ pa_locations | tojson }}'>
            <input type="hidden" name="sub_segment_length" value="{{ sub_segment_length }}">
            <input type="hidden" name="altimetry_plot_url" value="{{ altimetry_plot_url }}">
            <input type="hidden" name="map_plot_url" value="{{ map_plot_url }}">
            <input type="hidden" name="segment_data" value='{{ segment_data | tojson }}'>
    
            <div class="flex justify-center mb-4">
                <input type="hidden" name="action" value="calculate_times">
                <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-full shadow-md hover:bg-blue-700 transition-colors">Calcular Tiempos</button>
            </div>
        </form>
    </div>
    
    {% if time_results %}
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg mb-8">
        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-700">Resultados de Tiempos por Sub-segmento</h2>
        <table class="w-full table-fixed border-collapse bg-white rounded-lg shadow-md overflow-hidden">
            <thead class="bg-gray-200 sticky top-0 z-10">
                <tr>
                    <th class="p-2 border border-gray-300 text-center">Distancia<br>origen<br>(km)</th>
                    <th class="p-2 border border-gray-300 text-center">Tipo</th>
                    <th class="p-2 border border-gray-300 text-center">Tiempo Acumulado<br>desde el inicio</th>
                    <th class="p-2 border border-gray-300 text-center">Tiempo Acumulado<br>desde el último PA</th>
                    <th class="p-2 border border-gray-300 text-center">Ritmo<br>(mm:ss)</th>
                </tr>
            </thead>
            <tbody>
                {% for result in time_results %}
                <tr>
                    <td class="p-2 border border-gray-300 text-center">{{ "%.2f"|format(result.dist_origen_km) }}</td>
                    <td class="p-2 border border-gray-300 text-center">{{ result.type }}</td>
                    <td class="p-2 border border-gray-300 text-center">{{ result.total_time_formatted }}</td>
                    <td class="p-2 border border-gray-300 text-center">{{ result.pa_time_formatted }}</td>
                    <td class="p-2 border border-gray-300 text-center">{{ result.pace_formatted }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    {% if pa_summary %}
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg mb-8">
        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-700">Resumen por Puestos de Abastecimiento</h2>
        <table class="w-full table-fixed border-collapse bg-white rounded-lg shadow-md overflow-hidden">
            <thead class="bg-gray-200 sticky top-0 z-10">
                <tr>
                    <th class="p-2 border border-gray-300 text-center">Punto</th>
                    <th class="p-2 border border-gray-300 text-center">Distancia<br>Total<br>(km)</th>
                    <th class="p-2 border border-gray-300 text-center">Tiempo<br>Total</th>
                    <th class="p-2 border border-gray-300 text-center">Distancia<br>Desde PA<br>(km)</th>
                    <th class="p-2 border border-gray-300 text-center">Tiempo<br>Desde PA</th>
                    <th class="p-2 border border-gray-300 text-center">Altitud<br>Positiva<br>Total (m)</th>
                    <th class="p-2 border border-gray-300 text-center">Altitud<br>Positiva<br>Desde PA (m)</th>
                    <th class="p-2 border border-gray-300 text-center">Altitud<br>Negativa<br>Total (m)</th>
                    <th class="p-2 border border-gray-300 text-center">Altitud<br>Negativa<br>Desde PA (m)</th>
                </tr>
            </thead>
            <tbody>
                {% for summary in pa_summary %}
                <tr>
                    <td class="p-2 border border-gray-300 text-center">{{ summary.label }}</td>
                    <td class="p-2 border border-gray-300 text-center">{{ summary.dist_total_km }}</td>
                    <td class="p-2 border border-gray-300 text-center">{{ summary.tiempo_total_s }}</td>
                    <td class="p-2 border border-gray-300 text-center">{{ summary.dist_desde_pa_km }}</td>
                    <td class="p-2 border border-gray-300 text-center">{{ summary.tiempo_desde_pa_s }}</td>
                    <td class="p-2 border border-gray-300 text-center">{{ summary.alt_pos_total }}</td>
                    <td class="p-2 border border-gray-300 text-center">{{ summary.alt_pos_desde_pa }}</td>
                    <td class="p-2 border border-gray-300 text-center">{{ summary.alt_neg_total }}</td>
                    <td class="p-2 border border-gray-300 text-center">{{ summary.alt_neg_desde_pa }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <div class="max-w-4xl mx-auto my-8 text-center">
      <a href="/" class="inline-block bg-gray-500 text-white font-bold py-3 px-8 rounded-full shadow-md hover:bg-gray-600 transition-colors">Volver a empezar</a>
    </div>

    <script>
        // La lógica de JavaScript original no ha sido modificada
        let restStopCount = 1;
        function addRestStop() {
            const tableBody = document.getElementById('restStopsTable').getElementsByTagName('tbody')[0];
            const newRow = tableBody.insertRow();
            
            const cell1 = newRow.insertCell(0);
            const cell2 = newRow.insertCell(1);
            const cell3 = newRow.insertCell(2);
            
            cell1.innerHTML = restStopCount + 1;
            cell2.innerHTML = `<input type="text" class="rest-input w-full p-1 border border-gray-300 rounded-md text-center" name="rest_stop_km_${restStopCount}" placeholder="Ej: 5.5">`;
            cell3.innerHTML = `<input type="text" class="rest-input w-full p-1 border border-gray-300 rounded-md text-center" name="rest_stop_min_${restStopCount}" placeholder="Ej: 10">`;

            restStopCount++;
        }
    </script>
</body>
</html>

